<textarea name="code" class="sql:nogutter"rows="50" cols="100">
<!--
DROP TABLE PACIENTE;

CREATE TABLE PACIENTE
( "ID_PAC" CHAR(5 BYTE) PRIMARY KEY,
  "NOMBRE" VARCHAR2(35 BYTE) NOT NULL,
  "APELLIDOS" VARCHAR2(50 BYTE) NOT NULL,
  "NUHSA" CHAR(12 BYTE) NOT NULL UNIQUE, /*2 LETRAS Y 10 NUMEROS*/
  "NHC" CHAR(7 BYTE) NOT NULL UNIQUE, /* Nº HISTORIA CLINICA DIGITAL, 7 NUMEROS*/
  "DIAGNOSTICO" VARCHAR2(50 BYTE),
  "MEDICACION_AUX" VARCHAR2(30 BYTE),
  "FECHA_INCLUSION" DATE,
  "ID_EC" CHAR(5 BYTE) NOT NULL,
  FOREIGN KEY(ID_EC) REFERENCES ENSAYO_CLINICO);
  
CREATE OR REPLACE TRIGGER PACIENTE_ELIMINA_ID_EC
    BEFORE UPDATE OR DELETE OF ID_EC ON PACIENTE
        FOR EACH ROW
BEGIN
	IF NOT(:NEW.ID_EC = :OLD.ID_EC)
     THEN raise_application_error(-20200,'No se puede modificar la pertenencia de un paciente a un ensayo clínico');
  	END IF;
END PACIENTE_ELIMINA_ID_EC;
/
ALTER TRIGGER PACIENTE_ELIMINA_ID_EC DISABLE;
/
DROP SEQUENCE SEC_ID_PAC;
/
CREATE SEQUENCE  SEC_ID_PAC  MINVALUE 0 INCREMENT BY 1 START WITH 0;
/
CREATE OR REPLACE FUNCTION VALIDANIF ( 
ENTRADA IN VARCHAR2)
RETURN BOOLEAN AS
	letrasValidas CHAR(23) := 'TRWAGMYFPDXBNJZSQVHLCKE';
	letraCorrecta CHAR;
	valor INTEGER;
	longitud INTEGER;
	resto INTEGER;
	letraInput CHAR;
BEGIN
	SELECT LENGTH(ENTRADA) INTO longitud FROM DUAL;
	SELECT SUBSTR(ENTRADA,0, longitud - 1) INTO valor FROM DUAL;
	SELECT SUBSTR(ENTRADA, longitud) INTO letraInput FROM DUAL;
	resto := valor MOD 23;
	SELECT SUBSTR(letrasValidas, resto+1, 1)INTO letraCorrecta FROM DUAL;
	IF (not((letraCorrecta = UPPER(letraInput)) AND (longitud=9)))
		THEN return(FALSE);
	ELSE
		return(TRUE);
	END IF;
END VALIDANIF;
/
CREATE OR REPLACE FUNCTION VALIDANHC ( 
ENTRADA IN VARCHAR2)
RETURN BOOLEAN AS
	valor INTEGER;
	longitud INTEGER;
BEGIN
	SELECT LENGTH(ENTRADA) INTO longitud FROM DUAL;
	SELECT TO_NUMBER(ENTRADA) INTO valor FROM DUAL;
	IF (not(((valor>=0) AND (valor<=9999999)) AND (longitud=7)))
		THEN return(FALSE);
	ELSE
		return(TRUE);
	END IF;
END VALIDANHC; 
/
CREATE OR REPLACE FUNCTION VALIDANUHSA ( 
ENTRADA IN VARCHAR2)
RETURN BOOLEAN AS
	valor INTEGER;
	longitud INTEGER;
	letraInput VARCHAR2(2 BYTE);
BEGIN
	SELECT LENGTH(ENTRADA) INTO longitud FROM DUAL;
	SELECT SUBSTR(ENTRADA,1, 2) INTO letraInput FROM DUAL;
	SELECT (SELECT TO_NUMBER(SUBSTR(ENTRADA, 3)) FROM DUAL) INTO valor FROM DUAL;
	IF NOT(((valor>=0)AND (valor<=9999999999)) AND(longitud=12))
		THEN return(FALSE);
	ELSE
		return(TRUE);
	END IF;
END VALIDANUHSA; 
/
CREATE OR REPLACE FUNCTION PAC_CITA_PROX_SIETE_DIAS 
(r_ID_EC IN PACIENTE.ID_EC%TYPE)
RETURN CURSOR
IS --informe cursor;
DECLARE
BEGIN
	cursor informe is SELECT FECHA,TIPO,NOMBRE,APELLIDOS  FROM PACIENTE, FECHA_PACIENTE	
	WHERE (--1ºFECHA
		(FECHA BETWEEN SYSDATE AND (SYSDATE + 7))
		AND --2ºEC
		(ID_EC = r_ID_EC)
	);
	return(informe);
END PAC_CITA_PROX_SIETE_DIAS;
/
CREATE OR REPLACE PROCEDURE CREA_PACIENTE
(w_NOMBRE IN PACIENTE.NOMBRE%TYPE,
 w_APELLIDOS IN PACIENTE.APELLIDOS%TYPE, 
 w_NUHSA IN PACIENTE.NUHSA%TYPE,
 w_NHC IN PACIENTE.NHC%TYPE, 
 w_DIAGNOSTICO IN PACIENTE.DIAGNOSTICO%TYPE,
 w_MEDICACION_AUX IN PACIENTE.MEDICACION_AUX%TYPE, 
 w_FECHA_INCLUSION IN PACIENTE.FECHA_INCLUSION%TYPE,
 w_ID_EC IN PACIENTE.ID_EC%TYPE
 )IS
 BEGIN
	INSERT INTO PACIENTE(ID_PAC, NOMBRE, APELLIDOS, NUHSA, NHC, DIAGNOSTICO, MEDICACION_AUX, FECHA_INCLUSION, ID_EC) 
	VALUES (SEC_ID_PAC.NEXTVAL , w_NOMBRE, w_APELLIDOS, w_NUHSA, w_NHC, w_DIAGNOSTICO, w_MEDICACION_AUX, w_FECHA_INCLUSION, w_ID_EC);
	COMMIT WORK;
END CREA_PACIENTE;
/
-->
</textarea>